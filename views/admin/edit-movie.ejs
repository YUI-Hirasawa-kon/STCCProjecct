<%
const layout = 'layouts/main';
%>

<div class="row justify-content-center">
  <div class="col-lg-10">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0">
            <i class="fas fa-edit me-2"></i>Edit Movie - <%= movie.title %>
          </h4>
          <div>
            <a href="/admin" class="btn btn-outline-light btn-sm me-2">
              <i class="fas fa-arrow-left me-1"></i>Back
            </a>
            <a href="/movies/<%= movie._id %>" class="btn btn-outline-light btn-sm" target="_blank">
              <i class="fas fa-eye me-1"></i>Preview
            </a>
          </div>
        </div>
      </div>
      <div class="card-body">
        <% if (error) { %>
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        <% } %>

               <form action="/admin/movies/<%= movie._id %>?_method=PUT" method="POST" id="movieForm">
          <div class="row g-4">
            <!-- base info -->
            <div class="col-12">
              <h5 class="border-bottom pb-2 mb-3">
                <i class="fas fa-info-circle me-2 text-primary"></i>Basic Information
              </h5>
            </div>

            <!-- Movie Title -->
            <div class="col-md-6">
              <label for="title" class="form-label">Title <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                id="title"
                name="title"
                value="<%= movie.title %>"
                required
                maxlength="100"
                placeholder="Enter movie title"
              >
            </div>

            <!-- English Title -->
            <div class="col-md-6">
              <label for="englishTitle" class="form-label">English Title</label>
              <input
                type="text"
                class="form-control"
                id="englishTitle"
                name="englishTitle"
                value="<%= movie.englishTitle || '' %>"
                maxlength="100"
                placeholder="Please enter an English title."
              >
            </div>

            <!-- Director -->
            <div class="col-md-6">
              <label for="director" class="form-label">Director <span class="text-danger">*</span></label>
              <input
                type="text"
                class="form-control"
                id="director"
                name="director"
                value="<%= movie.director %>"
                required
                placeholder="Enter director name"
              >
            </div>

            <!-- rating -->
            <div class="col-md-6">
              <label for="rating" class="form-label">HK Rating <span class="text-danger">*</span></label>
              <select class="form-select" id="rating" name="rating" required>
                <option value="">Select rating</option>
                <option value="I" <%= movie.rating === 'I' ? 'selected' : '' %>>I - All ages admitted</option>
                <option value="IIA" <%= movie.rating === 'IIA' ? 'selected' : '' %>>IIA - Not Suitable for Children</option>
                <option value="IIB" <%= movie.rating === 'IIB' ? 'selected' : '' %>>IIB - Not Suitable for Young Persons and Children</option>
                <option value="III" <%= movie.rating === 'III' ? 'selected' : '' %>>III - Persons Aged 18 and Above Only</option>
              </select>
            </div>

            <!-- Release Date -->
            <div class="col-md-4">
              <label for="releaseDate" class="form-label">Release Date <span class="text-danger">*</span></label>
              <input
                type="date"
                class="form-control"
                id="releaseDate"
                name="releaseDate"
                value="<%= movie.releaseDate.toISOString().split('T')[0] %>"
                required
              >
            </div>

            <!-- Duration -->
            <div class="col-md-4">
              <label for="duration" class="form-label">Duration (mins) <span class="text-danger">*</span></label>
              <input
                type="number"
                class="form-control"
                id="duration"
                name="duration"
                value="<%= movie.duration %>"
                required
                min="1"
                max="500"
                placeholder="120"
              >
            </div>

            <!-- language -->
            <div class="col-md-4">
              <label for="language" class="form-label">Language</label>
              <input
                type="text"
                class="form-control"
                id="language"
                name="language"
                value="<%= movie.language || 'English' %>"
                placeholder="English"
              >
            </div>

            <!-- description -->
            <div class="col-12">
              <label for="description" class="form-label">Description <span class="text-danger">*</span></label>
              <textarea
                class="form-control"
                id="description"
                name="description"
                rows="4"
                maxlength="2000"
                required
                placeholder="Enter description"
              ><%= movie.description %></textarea>
              <div class="form-text">Up to 2000 characters</div>
            </div>

            <!-- Display Information -->
            <div class="col-12 mt-4">
              <h5 class="border-bottom pb-2 mb-3">
                <i class="fas fa-film me-2 text-primary"></i>Display Information
              </h5>
            </div>

            <!-- Poster Image URL -->
            <div class="col-12">
              <label for="posterUrl" class="form-label">Poster Image URL <span class="text-danger">*</span></label>
              <input
                type="url"
                class="form-control"
                id="posterUrl"
                name="posterUrl"
                value="<%= movie.posterUrl %>"
                required
                placeholder="https://example.com/poster.jpg"
              >
              <div class="form-text">Please provide a full poster image URL</div>
              <% if (movie.posterUrl) { %>
                <div class="mt-3">
                  <p class="text-muted mb-2">Current Poster Preview:</p>
                  <img src="<%= movie.posterUrl %>" alt="Current Poster" style="max-height: 200px;" class="img-thumbnail">
                </div>
              <% } %>
            </div>

            <!-- Categories info -->
            <div class="col-12 mt-4">
              <h5 class="border-bottom pb-2 mb-3">
                <i class="fas fa-tags me-2 text-primary"></i>Categories
              </h5>
            </div>

            <!-- Movie Genres -->
            <div class="col-12">
              <label class="form-label">Genres <span class="text-danger">*</span></label>
              <div class="row g-2">
                <%
                const commonGenres = [
                  { label: 'Action', value: 'Action' },
                  { label: 'Comedy', value: 'Comedy' },
                  { label: 'Drama', value: 'Drama' },
                  { label: 'Romance', value: 'Romance' },
                  { label: 'Sci-Fi', value: 'Sci-Fi' },
                  { label: 'Horror', value: 'Horror' },
                  { label: 'Mystery', value: 'Mystery' },
                  { label: 'Animation', value: 'Animation' },
                  { label: 'Crime', value: 'Crime' },
                  { label: 'Adventure', value: 'Adventure' },
                  { label: 'Fantasy', value: 'Fantasy' },
                  { label: 'Documentary', value: 'Documentary' }
                ];
                const currentGenres = Array.isArray(movie.genres) ? movie.genres : (movie.genres ? [movie.genres] : []);
                commonGenres.forEach(genre => { %>
                  <div class="col-md-3 col-6">
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        name="genres"
                        value="<%= genre.value %>"
                        id="genre-<%= genre.value %>"
                        <%= currentGenres.includes(genre.value) ? 'checked' : '' %>
                      >
                      <label class="form-check-label" for="genre-<%= genre.value %>">
                        <%= genre.label %>
                      </label>
                    </div>
                  </div>
                <% }); %>
                <div class="col-12 mt-2">
                  <div class="input-group input-group-sm">
                    <input
                      type="text"
                      class="form-control"
                      id="customGenre"
                      placeholder="Add custom genres (comma separated)"
                    >
                    <button type="button" class="btn btn-outline-secondary" onclick="addCustomGenres()">
                      <i class="fas fa-plus me-1"></i>Add
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- cast -->
            <div class="col-12">
              <label for="cast" class="form-label">Cast</label>
              <textarea
                class="form-control"
                id="cast"
                name="cast"
                rows="3"
                placeholder="Jackie CHAN"
              ><%= Array.isArray(movie.cast) ? movie.cast.join(', ') : (movie.cast || '') %></textarea>
              <div class="form-text">Separate multiple actors with commas</div>
            </div>

            <!-- Theater Information -->
            <div class="col-12 mt-4">
              <h5 class="border-bottom pb-2 mb-3">
                <i class="fas fa-map-marker-alt me-2 text-primary"></i>Theater Information
              </h5>
            </div>

            <!-- Theater Location -->
            <div class="col-md-6">
              <label for="theaterLocation" class="form-label">Theater Location</label>
              <input
                type="text"
                class="form-control"
                id="theaterLocation"
                name="theaterLocation"
                value="<%= movie.theaterLocation || 'HongKong' %>"
                placeholder="HongKong"
              >
            </div>

            <!-- special Format -->
            <div class="col-md-6">
              <label for="specialFormat" class="form-label">Special Format</label>
              <select class="form-select" id="specialFormat" name="specialFormat">
                <option value="2D" <%= movie.specialFormat === '2D' ? 'selected' : '' %>>2D</option>
                <option value="3D" <%= movie.specialFormat === '3D' ? 'selected' : '' %>>3D</option>
                <option value="IMAX" <%= movie.specialFormat === 'IMAX' ? 'selected' : '' %>>IMAX</option>
                <option value="4DX" <%= movie.specialFormat === '4DX' ? 'selected' : '' %>>4DX</option>
                <option value="杜比全景声" <%= movie.specialFormat === 'Dolby Atmos' ? 'selected' : '' %>>Dolby Atmos</option>
                <option value="无" <%= !movie.specialFormat || movie.specialFormat === '无' ? 'selected' : '' %>>无</option>
              </select>
            </div>

            <!-- Theater Address -->
            <div class="col-12">
              <label for="theaterAddress" class="form-label">Theater Address</label>
              <input
                type="text"
                class="form-control"
                id="theaterAddress"
                name="theaterAddress"
                value="<%= movie.theaterAddress || '' %>"
                placeholder="100 Nathan Road, Tsim Sha Tsui, Kowloon, Hong Kong"
              >
            </div>

            <!-- Show times -->
            <div class="col-md-6">
              <label for="showTimes" class="form-label">Showtimes</label>
              <textarea
                class="form-control"
                id="showTimes"
                name="showTimes"
                rows="3"
                placeholder="14:30, 17:00, 19:30, 22:00"
              ><%= Array.isArray(movie.showTimes) ? movie.showTimes.join(', ') : (movie.showTimes || '') %></textarea>
              <div class="form-text">Separate times with commas (24-hour format)</div>
            </div>

            <!-- Subtitle Languages -->
            <div class="col-md-6">
              <label for="subtitles" class="form-label">Subtitle Languages</label>
              <textarea
                class="form-control"
                id="subtitles"
                name="subtitles"
                rows="3"
                placeholder="Chinese, English"
              ><%= Array.isArray(movie.subtitles) ? movie.subtitles.join(', ') : (movie.subtitles || 'English') %></textarea>
              <div class="form-text">Separate languages with commas</div>
            </div>

            <!-- ticket Price -->
            <div class="col-md-6">
              <label for="ticketPrice" class="form-label">Ticket Price (HKD)</label>
              <div class="input-group">
                <span class="input-group-text">HKD</span>
                <input
                  type="number"
                  class="form-control"
                  id="ticketPrice"
                  name="ticketPrice"
                  value="<%= movie.ticketPrice || 80 %>"
                  min="0"
                  step="5"
                  placeholder="80"
                >
              </div>
            </div>

            <!-- Status info -->
            <div class="col-md-6">
              <label class="form-label d-block">Status</label>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="isFull"
                  name="isFull"
                  <%= movie.isFull ? 'checked' : '' %>
                >
                <label class="form-check-label" for="isFull">
                  Mark as full
                </label>
              </div>
              <div class="form-text">When enabled, movie shows as full</div>
            </div>
          </div>

          <!-- form buttons -->
          <div class="mt-5 border-top pt-4">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <button type="submit" class="btn btn-primary me-2">
                  <i class="fas fa-save me-2"></i>Update Movie
                </button>
                <a href="/admin" class="btn btn-outline-secondary me-2">
                  <i class="fas fa-times me-2"></i>Cancel
                </a>
              </div>
              <div>
                <a href="/movies/<%= movie._id %>" class="btn btn-outline-info me-2" target="_blank">
                  <i class="fas fa-eye me-2"></i>View Details
                </a>
                <button type="button" class="btn btn-outline-warning" onclick="resetForm()">
                  <i class="fas fa-undo me-2"></i>Reset
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Add custom type function
function addCustomGenres() {
  const customText = document.getElementById('customGenre').value;
  if (!customText.trim()) {
    alert('Please enter custom genres');
    return;
  }

  const genres = customText.split(',').map(g => g.trim()).filter(g => g);
  const container = document.querySelector('.row.g-2');

  genres.forEach(genre => {
    const existingCheckbox = document.querySelector(`input[value="${genre}"]`);
    if (!existingCheckbox) {
      const newCol = document.createElement('div');
      newCol.className = 'col-md-3 col-6';
      newCol.innerHTML = `
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="genres" value="${genre}" id="genre-custom-${genre}" checked>
          <label class="form-check-label" for="genre-custom-${genre}">
            ${genre}
          </label>
        </div>
      `;
      container.insertBefore(newCol, container.lastElementChild);
    }
  });

  document.getElementById('customGenre').value = '';
}

// Reset
function resetForm() {
  if (confirm('Are you sure you want to reset the form? Unsaved changes will be lost.')) {
    document.getElementById('movieForm').reset();

    // Reset the selected type
    const currentGenres = <%= JSON.stringify(currentGenres) %>;
    document.querySelectorAll('input[name="genres"]').forEach(checkbox => {
      checkbox.checked = currentGenres.includes(checkbox.value);
    });
  }
}

// Form Validation
document.getElementById('movieForm').addEventListener('submit', function(e) {
  let isValid = true;
  const requiredFields = this.querySelectorAll('[required]');

  // Check required fields
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      isValid = false;
      field.classList.add('is-invalid');

      // Add error message
      if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('invalid-feedback')) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.textContent = 'This field is required';
        field.parentNode.appendChild(errorDiv);
      }
    } else {
      field.classList.remove('is-invalid');
    }
  });

  // Check that at least one type is selected.
  const genreCheckboxes = this.querySelectorAll('input[name="genres"]:checked');
  if (genreCheckboxes.length === 0) {
    isValid = false;
    alert('Please select at least one genre!');
  }

  // Validate URL format
  const posterUrl = document.getElementById('posterUrl');
  if (posterUrl.value && !isValidUrl(posterUrl.value)) {
    isValid = false;
    posterUrl.classList.add('is-invalid');
    alert('Please provide a valid poster URL (must start with http:// or https://)');
  }

  if (!isValid) {
    e.preventDefault();
    // Scroll to the first error field
    const firstError = this.querySelector('.is-invalid');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstError.focus();
    }
  }
});

// URL validation function
function isValidUrl(string) {
  try {
    new URL(string);
    return string.startsWith('http://') || string.startsWith('https://');
  } catch (_) {
    return false;
  }
}

// Real-time verification
document.querySelectorAll('#movieForm [required]').forEach(field => {
  field.addEventListener('input', function() {
    if (this.value.trim()) {
      this.classList.remove('is-invalid');
    }
  });
});

// Poster URL Preview
document.getElementById('posterUrl').addEventListener('change', function() {
  const preview = this.parentNode.querySelector('.mt-3');
  if (this.value && isValidUrl(this.value)) {
    if (!preview) {
      const previewDiv = document.createElement('div');
      previewDiv.className = 'mt-3';
      previewDiv.innerHTML = `
        <p class="text-muted mb-2">Poster Preview:</p>
        <img src="${this.value}" alt="Poster Preview" style="max-height: 200px;" class="img-thumbnail" onerror="this.style.display='none'">
      `;
      this.parentNode.appendChild(previewDiv);
    } else {
      const img = preview.querySelector('img');
      img.src = this.value;
      img.style.display = 'block';
    }
  } else if (preview) {
    preview.querySelector('img').style.display = 'none';
  }
});
</script>
